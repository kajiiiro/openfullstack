<!DOCTYPE html>
<!-- saved from url=(0030)http://www.yota.tokyo/?paged=2 -->
<html lang="ja" class="js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Open Full Stack – ページ 2</title>
<link rel="dns-prefetch" href="http://www.yota.tokyo/">
<link rel="dns-prefetch" href="http://fonts.googleapis.com/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Open Full Stack » フィード" href="http://www.yota.tokyo/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="Open Full Stack » コメントフィード" href="http://www.yota.tokyo/?feed=comments-rss2">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":".\/2\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./2/wp-emoji-release.min.js" type="text/javascript"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="twentysixteen-fonts-css" href="./2/css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="./2/genericons.css" type="text/css" media="all">
<link rel="stylesheet" id="twentysixteen-style-css" href="./2/style.css" type="text/css" media="all">
<style id="twentysixteen-style-inline-css" type="text/css">

		/* Custom Page Background Color */
		.site {
			background-color: #e0dfd5;
		}

		mark,
		ins,
		button,
		button[disabled]:hover,
		button[disabled]:focus,
		input[type="button"],
		input[type="button"][disabled]:hover,
		input[type="button"][disabled]:focus,
		input[type="reset"],
		input[type="reset"][disabled]:hover,
		input[type="reset"][disabled]:focus,
		input[type="submit"],
		input[type="submit"][disabled]:hover,
		input[type="submit"][disabled]:focus,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.pagination .prev,
		.pagination .next,
		.pagination .prev:hover,
		.pagination .prev:focus,
		.pagination .next:hover,
		.pagination .next:focus,
		.pagination .nav-links:before,
		.pagination .nav-links:after,
		.widget_calendar tbody a,
		.widget_calendar tbody a:hover,
		.widget_calendar tbody a:focus,
		.page-links a,
		.page-links a:hover,
		.page-links a:focus {
			color: #e0dfd5;
		}

		@media screen and (min-width: 56.875em) {
			.main-navigation ul ul li {
				background-color: #e0dfd5;
			}

			.main-navigation ul ul:after {
				border-top-color: #e0dfd5;
				border-bottom-color: #e0dfd5;
			}
		}
	

		/* Custom Main Text Color */
		body,
		blockquote cite,
		blockquote small,
		.main-navigation a,
		.menu-toggle,
		.dropdown-toggle,
		.social-navigation a,
		.post-navigation a,
		.pagination a:hover,
		.pagination a:focus,
		.widget-title a,
		.site-branding .site-title a,
		.entry-title a,
		.page-links > .page-links-title,
		.comment-author,
		.comment-reply-title small a:hover,
		.comment-reply-title small a:focus {
			color: #494949
		}

		blockquote,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.post-navigation,
		.post-navigation div + div,
		.pagination,
		.widget,
		.page-header,
		.page-links a,
		.comments-title,
		.comment-reply-title {
			border-color: #494949;
		}

		button,
		button[disabled]:hover,
		button[disabled]:focus,
		input[type="button"],
		input[type="button"][disabled]:hover,
		input[type="button"][disabled]:focus,
		input[type="reset"],
		input[type="reset"][disabled]:hover,
		input[type="reset"][disabled]:focus,
		input[type="submit"],
		input[type="submit"][disabled]:hover,
		input[type="submit"][disabled]:focus,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.pagination:before,
		.pagination:after,
		.pagination .prev,
		.pagination .next,
		.page-links a {
			background-color: #494949;
		}

		/* Border Color */
		fieldset,
		pre,
		abbr,
		acronym,
		table,
		th,
		td,
		input[type="date"],
		input[type="time"],
		input[type="datetime-local"],
		input[type="week"],
		input[type="month"],
		input[type="text"],
		input[type="email"],
		input[type="url"],
		input[type="password"],
		input[type="search"],
		input[type="tel"],
		input[type="number"],
		textarea,
		.main-navigation li,
		.main-navigation .primary-menu,
		.menu-toggle,
		.dropdown-toggle:after,
		.social-navigation a,
		.image-navigation,
		.comment-navigation,
		.tagcloud a,
		.entry-content,
		.entry-summary,
		.page-links a,
		.page-links > span,
		.comment-list article,
		.comment-list .pingback,
		.comment-list .trackback,
		.comment-reply-link,
		.no-comments,
		.widecolumn .mu_register .mu_alert {
			border-color: #494949; /* Fallback for IE7 and IE8 */
			border-color: rgba( 73, 73, 73, 0.2);
		}

		hr,
		code {
			background-color: #494949; /* Fallback for IE7 and IE8 */
			background-color: rgba( 73, 73, 73, 0.2);
		}

		@media screen and (min-width: 56.875em) {
			.main-navigation ul ul,
			.main-navigation ul ul li {
				border-color: rgba( 73, 73, 73, 0.2);
			}

			.main-navigation ul ul:before {
				border-top-color: rgba( 73, 73, 73, 0.2);
				border-bottom-color: rgba( 73, 73, 73, 0.2);
			}
		}
	
</style>
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script type='text/javascript' src='http://www.yota.tokyo/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<script type="text/javascript" src="./2/jquery.js"></script>
<script type="text/javascript" src="./2/jquery-migrate.min.js"></script>
<link rel="https://api.w.org/" href="http://www.yota.tokyo/?rest_route=/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.yota.tokyo/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.yota.tokyo/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 4.6.1">
<style type="text/css" id="custom-background-css">
body.custom-background { background-color: #e0dfd5; }
</style>
<link rel="icon" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-32x32.png" sizes="32x32">
<link rel="icon" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-192x192.png" sizes="192x192">
<link rel="apple-touch-icon-precomposed" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-180x180.png">
<meta name="msapplication-TileImage" content="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-270x270.png">
</head>

<body class="home blog paged logged-in custom-background paged-2 hfeed">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="http://www.yota.tokyo/?paged=2#content">コンテンツへスキップ</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<h1 class="site-title"><a href="http://www.yota.tokyo/" rel="home">Open Full Stack</a></h1>
									</div><!-- .site-branding -->

							</div><!-- .site-header-main -->

					</header><!-- .site-header -->

		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
			
<article id="post-34" class="post-34 post type-post status-publish format-standard hentry category-wordpress">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=34" rel="bookmark">wordpressで二段階認証が導入できなかった件</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>wordpressを利用してまだ間もないので、wordpressの設定等を色々いじっています。</p>
<p>基本的な機能は大体把握、というかCMSを考えた場合の機能がしっかりとあります。redmineぐらい完成度の高いツールだと思います。</p>
<p>ですがwordpress本体の機能だけでは少し足りません。<br>
そのため、肝はプラグインにあると思います。プラグイン使いたくてとりあえずCrazy BoneとGoogle Authenticatorを有効にしてセキュリティを高めよう！と思った初心者(私)の話をします。</p>
<p>結論からいうとCrazy BoneとGoogle Authenticatorを同時に有効にしてはいけません。</p>
<p>まずはプラグインの説明をします。Crazy Boneは管理画面にログインしたユーザのIPアドレスから国名を特定しログイン履歴を残します。何かあった時、怪しい人がアクセスしていないかを確認できます。<br>
Google Authenticatorは二段階認証を導入できるプラグインです。ログイン時に2つ目のパスコード等が聞かれます。<br>
これらのプラグインはどちらもログインのアクションに対し何かしらの動作を実施します。そのためGoogle Authenticatorプラグインのセキュリティポリシと競合し結果ログインできなくなってしまいました。</p>
<p>その時の対策を示します。ただしこれはDBにアクセスできる方限定の方法となります。<br>
まずwordpressが利用するDBにアクセスします。そして以下のコマンドを発行して下さい。</p>
<pre>mysql&gt; select * from wp_options WHERE option_name = 'active_plugins';
+-----------+----------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------+
| option_id | option_name | option_value | autoload |
+-----------+----------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------+
| 33 | active_plugins | a:3:{i:0;s:21:"crazy-bone/plugin.php";i:1;s:33:"nginx-champuru/nginx-champuru.php";i:2;s:41:"wp-multibyte-patch/wp-multibyte-patch.php";} | yes |
+-----------+----------------+-------------------------------------------------------------------------------------------------------------------------------------------+----------+
1 row in set (0.00 sec)</pre>
<p>上記のような結果が得られると思いますが、option_valueに有効なプラグインの一覧があるので、それを書き換えます。私は間違って変なフォーマットにして保存してしまいましたが（閉じブランケットを忘れて保存した）、wordpress側ではプラグインが全て無効になるだけで普通に動作し無事ログイン出来ました。その後、再度必要なプラグインを有効にして保存すれば上記のデータは元にもどります。</p>
<p>皆さんもログインできない場合は試してみて下さい。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./2/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=34" rel="bookmark"><time class="entry-date published" datetime="2015-06-28T10:04:12+00:00">2015-06-28</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=11" rel="category">wordpress</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=34&amp;action=edit"><span class="screen-reader-text">"wordpressで二段階認証が導入できなかった件"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-44" class="post-44 post type-post status-publish format-standard hentry category-postgresql category-wireshark">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=44" rel="bookmark">postgresqlのパケットキャプチャ(wireshark)</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>久しく記事を更新できていない。そこで思うことは記事を書くのは意外に大変だということです。一応、うそは書きたくないという技術者の誇りがあるもので…(格好つけてみました)。</p>
<p>この前、DBのチューニングを行う仕事があったのですが人のソースだったので、手っ取り早くSQLを取得するためにパケットキャプチャを行いました。たしかSQL垂れ流しだったよな〜と思っていたら、SQLがとれないので調査してみるとどうやらmysqlと勘違いしていたようです。cloudstackでmysqlを利用してたときはSQLをキャプチャして不安定な動作の原因を追ったりしていましたが、postgresqlではPGSQLプロトコルになるようですね。</p>
<p>tcpdumpでPGSQLを見るのは辛いものがありますが、wiresharkであれば勝手に理解してくれます。以下にtcpdumpでwireshark形式にて保存する方法を示します。</p>
<pre># tcpdump -i eth0 -w dump.pcap port 5432</pre>
<p>-wオプションに保存するファイルのパスを指定するだけでwiresharkで読み込めます。wiresharkではプロトコルの部分にPGSQLといった言葉がでてくるので、それを追えばSQLが取得できます。我が家の環境で調べたところ、PGSQLのSimple QueryメッセージにてSQLが取得できました。注意が必要なのはSSLにて暗号化しているとわからないです（awsのpostgresqlサービスはデフォでSSLのようです）。</p>
<p>にしても、SSL暗号をしないとデータベースのユーザ、パスワード等すべて丸見えですね。セキュリティを気にする場合、絶対にSSLを行わないといけないということがわかりました。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./2/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=44" rel="bookmark"><time class="entry-date published" datetime="2015-06-21T21:06:37+00:00">2015-06-21</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=9" rel="category">postgresql</a>, <a href="http://www.yota.tokyo/?cat=10" rel="category">wireshark</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=44&amp;action=edit"><span class="screen-reader-text">"postgresqlのパケットキャプチャ(wireshark)"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-24" class="post-24 post type-post status-publish format-standard hentry category-centos category-corosync category-drbd category-pacemaker category-postgresql">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=24" rel="bookmark">drbd+pacemakerを用いたシェアードナッシングHAクラスタ①</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>業務で利用するシステムは当然の要件として可用性が重要となる。</p>
<p>可用性を高める為にはスケールアップを行ってリソースの増強を図ったり、スケールアウトして冗長構成にしSPOF(単一障害点)をなくすことが考えられる。これらの内容については技術評論社のweb+db press plusシリーズ「24時間365日 サーバ/インフラを支える技術」を読むと考え方がわかります。</p>
<p>今回はpostgresqlをHA構成にして見ます。postgresqlには独自のストリーミングレプリケーションという機構がありますがすっごいわかりにくいです。ですがストリーミングレプリケーションをうまく使えばサービスの瞬断もなくなります。そこまではいかないけど十分実用的でかつ柔軟な構成がdrbd+pacemaker+postgresql(mysql等その他のサービスでもOK)で実現できます。</p>
<p>私はcentos6.6 64bitで試しました。また、内容を簡単にするため、iptables, selinuxは無効に設定しています。</p>
<h4>drbdの設定</h4>
<p>まずはdrbdのインストールからです。デフォルトのyumリポジトリにはありませんので、ここからrpmをダウンロードします。drbd84-utils, kmod-drbd84をインストールします。</p>
<pre># yum install http://www.ftp.ne.jp/Linux/RPMS/elrepo/elrepo/el6/x86_64/RPMS/drbd84-utils-8.9.1-1.el6.elrepo.x86_64.rpm http://www.ftp.ne.jp/Linux/RPMS/elrepo/elrepo/el6/x86_64/RPMS/kmod-drbd84-8.4.5-2.el6.elrepo.x86_64.rpm</pre>
<ul>
<li>/etc/drbd.d/global_common.conf</li>
</ul>
<p>drbdの設定を簡単に説明します。完全同期にするため、プロトコルCを選択します。その他は起動時の対抗のノードの存在をどの程度待つかの指定になります。</p>
<pre>global {
 usage-count no;
}
common {&nbsp;
 protocol C;
 handlers {}
 startup {
  wfc-timeout 10;
  degr-wfc-timeout 10;
  outdated-wfc-timeout 10;
 }
 options {}
 disk {}
 net {}
}</pre>
<ul>
<li>/etc/drbd.d/postgres.res</li>
</ul>
<p>この設定ファイルは自分で作成するものです。同期用の設定ファイルで指定するのはdrbdの仮想diskの名前(drbdXという名前である必要がある)どのdiskを同期するのか、自分と対抗のノードを指定します。ホスト名と同一の名前でないと同期してくれないで注意してください。</p>
<pre>resource postgres {
 device /dev/drbd0;
 disk /dev/vg_data/lv_postgres;
 meta-disk internal;
 on db01 {
  address 10.16.32.146:7788;
 }
 on db02 {
  address 10.16.32.147:7788;
 }
}</pre>
<p>ここで少し考えたいのはどういったdiskを同期すべきかということです。drbdはネットワークを経由することから、diskの書き込み速度はそれ程気にするところではないと考えられます。以下の2パターンが考えれらます。</p>
<p><a href="./2/drbd_disk_sync.png"><img class="alignnone size-medium wp-image-29" src="./2/drbd_disk_sync-300x238.png" alt="drbd_disk_sync" width="300" height="238" srcset="./2/drbd_disk_sync-300x238.png 300w, ./2/drbd_disk_sync.png 340w" sizes="(max-width: 300px) 85vw, 300px"></a></p>
<p>両者の違いを強いてあげるとすれば以下になると思います。</p>
<ol>
<li>オンラインdisk拡張の際にパターン1ではdrbdの拡張も必要で手順が一つ増えること</li>
<li>パターン2では物理diskの増加は吸収はできない(物理diskの容量が限界)</li>
<li>パターン2ではLVMのメタ情報も同期してしまう</li>
</ol>
<p>私は2つ目の条件がネックでパターン1としました。</p>
<p>以下のコマンドで同期を開始します。同期が完了するまでに少し時間がかかります。</p>
<pre># /etc/init.d/drbd start
# drbdadm create-md postgres
# drbdadm attach postgres
### ここまでは両方のノードで実行、以下の一行でprimaryに昇格させる
# drbdadm -- --overwrite-data-of-peer primary postgres
### 同期の状態を確認できる
# /etc/init.d/drbd status
# mkfs.ext4 /dev/drbd0
# chkconfig drbd off
# chkconfig --list drbd</pre>
<h3>postgresqlの設定</h3>
<p>ここはコマンドを並べてさらっと流します。centos6.6のデフォルトではpostgresqlの8.4とかが入るので、最新を入れます。最新ではjson型やストリーミングレプリケーションが利用できます。contribパッケージは暗号化の関数等が入っていますでパスワードを管理する際には必要になってくるかと思います。</p>
<pre>### postgresqlの初期化をする前にdrbdでマウントしておく
# yum install http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/postgresql94-9.4.1-1PGDG.rhel6.x86_64.rpm http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/postgresql94-contrib-9.4.1-1PGDG.rhel6.x86_64.rpm http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/postgresql94-libs-9.4.1-1PGDG.rhel6.x86_64.rpm http://yum.postgresql.org/9.4/redhat/rhel-6-x86_64/postgresql94-server-9.4.1-1PGDG.rhel6.x86_64.rpm
# mount /dev/drbd0 /var/lib/pgsql/9.4/data/
# chown postgres. /var/lib/pgsql/9.4/data/
### ext4のlost+fountがあるとinitdbが失敗する
# rmdir /var/lib/pgsql/9.4/data/*
# /etc/init.d/postgresql-9.4 initdb
# /etc/init.d/postgresql-9.4 start
# psql postgres postgres</pre>
<p>ここまででpostgresにアクセスできたら成功です。</p>
<p>疲れたので、次回にpacemakerの設定をしていきます。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./2/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=24" rel="bookmark"><time class="entry-date published" datetime="2015-05-03T15:39:21+00:00">2015-05-03</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=2" rel="category">centos</a>, <a href="http://www.yota.tokyo/?cat=8" rel="category">corosync</a>, <a href="http://www.yota.tokyo/?cat=6" rel="category">drbd</a>, <a href="http://www.yota.tokyo/?cat=7" rel="category">pacemaker</a>, <a href="http://www.yota.tokyo/?cat=9" rel="category">postgresql</a></span><span class="comments-link"><a href="http://www.yota.tokyo/?p=24#comments"><span class="screen-reader-text">drbd+pacemakerを用いたシェアードナッシングHAクラスタ① への</span>1件のコメント</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=24&amp;action=edit"><span class="screen-reader-text">"drbd+pacemakerを用いたシェアードナッシングHAクラスタ①"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-21" class="post-21 post type-post status-publish format-standard hentry category-vyos">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=21" rel="bookmark">vyosによるシステムネットワーク基盤構築①</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>初めての記事を何にしようか悩んだ末に出した答えはvyosでした。</p>
<p>sshd, ntpd, dhcp等どれも重要な機能ですが、どれもネットワークを利用します。</p>
<p>そこでvyosによるネットワーク基盤を作ることから始めようと考えました。</p>
<p>ここではkvmを用いて仮想化したvyosを元に説明を行います。kvmのブリッジ接続やvlan設定等は別途記事に起こす予定です。</p>
<p>isoのダウンロード、インストール方法は<a href="http://wiki.vyos-users.jp/" target="_blank">vyos jp ユーザガイド</a>を参考にしてください。というかほとんどの情報はユーザガイドに載っています。</p>
<p>以下にコマンドとともに各種設定を載せていきます。</p>
<p>※コマンドの前の「$」は操作モード時、「#」は設定モードを表します。</p>
<h3>vyosバージョン情報等の確認</h3>
<p>linuxのuname -aと似たコマンドは以下です。</p>
<pre>$ show host os
Linux vyos 3.13.11-1-amd64-vyos #1 SMP Wed Jan 7 22:24:09 UTC 2015 x86_64 GNU/Linux</pre>
<p>vyosのバージョンを確認するには以下。</p>
<pre>$ show version
Version: VyOS 1.1.3
以下、省略</pre>
<p>cpu情報。</p>
<div class="page" title="Page 48">
<div class="layoutArea">
<div class="column">
<pre>$ show hardware cpu
省略</pre>
</div>
</div>
</div>
<p>diskパーティション情報。パーティションはインストール時に変更できます。</p>
<div class="page" title="Page 49">
<div class="layoutArea">
<div class="column">
<pre>$ show disk sda format
省略
$ show system storage</pre>
</div>
</div>
</div>
<p>ここで余談ですが、vyosのdiskを別のシステムからみたいときがありました。vyosではoverlayfsというext4をラップしたようなファイルシステムを利用しています。このext4が始まる場所を特定して、オフセット位置指定を行いマウントすることができます。</p>
<div class="page" title="Page 46">
<div class="layoutArea">
<div class="column">
<pre># parted /path/to/vyosdisk unit b print
モデル: Linux device-mapper (linear) (dm)
<span style="line-height: 1.6471;">ディスク /dev/dm-5: 2147483648B
</span><span style="line-height: 1.6471;">セクタサイズ (論理/物理): 512B/512B
</span><span style="line-height: 1.6471;">パーティションテーブル: msdos
番号 開始 終了 サイズ タイプ ファイルシステム フラグ
</span><span style="line-height: 1.6471;">1 <span style="color: #ff0000;">1048576B</span> 2147483647B 2146435072B primary ext4 boot
</span><span style="line-height: 1.6471;"># mount -o loop,offset=<span style="color: #ff0000;">1048576</span> -t ext4 /path/to/vyosdisk /mnt</span></pre>
</div>
</div>
</div>
<p>インターフェイス情報。</p>
<div class="page" title="Page 49">
<div class="layoutArea">
<div class="column">
<pre>$ show interfaces</pre>
</div>
</div>
</div>
<h3>システム設定</h3>
<p>ホスト名、ゲートウェイの設定を行います。</p>
<pre># set system host-name [好きなホスト名]
# set system gateway-address [gateway ip]</pre>
<p>必要な場合はリモートのsyslogを利用します。</p>
<pre># set system syslog host [remote syslog ip] facility all level warning
# set system syslog host [remote syslog ip] facility all protocol udp
### インターフェイスを設定後syslog設定の有効性を確認するには、
### tcpdumpで通過するインターフェイスを指定する
### sudo tcpdump -i eth0 host [remote syslog ip]</pre>
<p>sshの設定はほとんど必須かと思います。リッスンIPは不要な場合は入りませんが、基本的にはWAN側から受け付けない方がいいです。DNSを利用してリモートホスト名を検証します。ですがDNSが存在しない場合などは接続までに時間がかかるようになってしまうので無効に設定します。</p>
<pre># set service ssh port '22'
# set service ssh listen-address [lan側 ip]
# set service ssh disable-host-validation
### この設定後以下のコマンドで接続してみる。
### ssh vyos@[lan側 ip]</pre>
<h3>ネットワークの設定</h3>
<p>まずはインターフェイスにIPアドレスを振らないと何もできません。</p>
<pre># set interfaces ethernet eth0 address 192.168.0.1/24
### wan側の設定とゲートウェイの設定が終わればインターネットにpingを打つ
### ping 8.8.8.8</pre>
<p>dnsが必要な場合は以下を設定します。ただし、vyos自体はdnsのリソース等を管理する機能は持たず、フォワードするだけです。ここではgoogleのパブリックドメインを利用させていただきます。</p>
<pre># set service dns forwarding cache-size 0
# set service dns forwarding name-server 8.8.8.8
# set service dns forwarding name-server 8.8.4.4</pre>
<p>ntpの設定をします。はじめから設定されているのは削除(以下のsetをdeleteに変更するだけ)して、nictの公開ntpサーバを設定します。</p>
<pre># set system ntp server ntp.nict.jp
# set system time-zone Asia/Tokyo</pre>
<p>本記事の最後はdhcpです。ntpやdnsも設定していることを前提に記載しているので、不要な方は該当箇所を抜かして設定してください。dhcpの割り当て範囲はサブネットで割り当てられる範囲からvyosの部分を外します。範囲に含めてもdhcpはそのIPを利用しているかしていないか確認するので、問題はないと思います。ですが不要な設定は除外します。また、vyosのIPは「192.168.0.254」を設定しているものとします。</p>
<pre># set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 default-router 192.168.0.254
# set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 dns-server 192.168.0.254
# set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 ntp-server 192.168.0.254
# set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 start 192.168.0.1 stop 192.168.0.253
### 以下は固定でIPアドレスを割り当てたい場合の設定
### 固定で割り当てたいインターフェイスのMACアドレスが必要になります。
# set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 static-mapping local1_1 ip-address 192.168.0.1
# set service dhcp-server shared-network-name local1 subnet 192.168.0.0/24 static-mapping local1_1 mac-address 52:54:00:03:06:ac</pre>
<p>他にもkickstartを用いるPXEブートではtftpサーバの設定もします。kickstartについては別の記事にする予定です。</p>
<p>上記の設定後、設定をセーブします。saveコマンドの引数にtftp等を用いて保存することも可能です。設定を読み込む場合に利用するloadコマンドも同様で、加えてhttpからも読み込めたりします。</p>
<pre># save</pre>
<p>次回はファイアウォールを設定していきます。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./2/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=21" rel="bookmark"><time class="entry-date published" datetime="2015-05-02T15:32:20+00:00">2015-05-02</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=5" rel="category">vyos</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=21&amp;action=edit"><span class="screen-reader-text">"vyosによるシステムネットワーク基盤構築①"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

	<nav class="navigation pagination" role="navigation">
		<h2 class="screen-reader-text">投稿ナビゲーション</h2>
		<div class="nav-links"><a class="prev page-numbers" href="http://www.yota.tokyo/">前のページ</a>
<a class="page-numbers" href="http://www.yota.tokyo/"><span class="meta-nav screen-reader-text">ページ </span>1</a>
<span class="page-numbers current"><span class="meta-nav screen-reader-text">ページ </span>2</span></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-2" class="widget widget_search">
<form role="search" method="get" class="search-form" action="http://www.yota.tokyo/">
	<label>
		<span class="screen-reader-text">検索対象:</span>
		<input type="search" class="search-field" placeholder="検索 …" value="" name="s">
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">検索</span></button>
</form>
</section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">アーカイブ</h2>		<ul>
			<li><a href="http://www.yota.tokyo/?m=201609">2016年9月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201608">2016年8月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201604">2016年4月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201601">2016年1月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201512">2015年12月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201510">2015年10月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201508">2015年8月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201507">2015年7月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201506">2015年6月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201505">2015年5月</a>&nbsp;(2)</li>
		</ul>
		</section><section id="pages-3" class="widget widget_pages"><h2 class="widget-title">本サイトについて</h2>		<ul>
			<li class="page_item page-item-15"><a href="http://www.yota.tokyo/?page_id=15">Open Full Stackとは？</a></li>
		</ul>
		</section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">カテゴリー</h2>		<ul>
	<li class="cat-item cat-item-19"><a href="http://www.yota.tokyo/?cat=19">aws</a> (1)
</li>
	<li class="cat-item cat-item-17"><a href="http://www.yota.tokyo/?cat=17">azure</a> (1)
</li>
	<li class="cat-item cat-item-21"><a href="http://www.yota.tokyo/?cat=21">bower</a> (1)
</li>
	<li class="cat-item cat-item-22"><a href="http://www.yota.tokyo/?cat=22">browserify</a> (1)
</li>
	<li class="cat-item cat-item-2"><a href="http://www.yota.tokyo/?cat=2">centos</a> (2)
</li>
	<li class="cat-item cat-item-8"><a href="http://www.yota.tokyo/?cat=8">corosync</a> (2)
</li>
	<li class="cat-item cat-item-6"><a href="http://www.yota.tokyo/?cat=6">drbd</a> (2)
</li>
	<li class="cat-item cat-item-14"><a href="http://www.yota.tokyo/?cat=14">github</a> (1)
</li>
	<li class="cat-item cat-item-20"><a href="http://www.yota.tokyo/?cat=20">gulp</a> (1)
</li>
	<li class="cat-item cat-item-18"><a href="http://www.yota.tokyo/?cat=18">iaas</a> (1)
</li>
	<li class="cat-item cat-item-12"><a href="http://www.yota.tokyo/?cat=12">javascript</a> (1)
</li>
	<li class="cat-item cat-item-16"><a href="http://www.yota.tokyo/?cat=16">nginx</a> (2)
</li>
	<li class="cat-item cat-item-13"><a href="http://www.yota.tokyo/?cat=13">node.js</a> (4)
</li>
	<li class="cat-item cat-item-7"><a href="http://www.yota.tokyo/?cat=7">pacemaker</a> (2)
</li>
	<li class="cat-item cat-item-15"><a href="http://www.yota.tokyo/?cat=15">php</a> (1)
</li>
	<li class="cat-item cat-item-9"><a href="http://www.yota.tokyo/?cat=9">postgresql</a> (4)
</li>
	<li class="cat-item cat-item-5"><a href="http://www.yota.tokyo/?cat=5">vyos</a> (1)
</li>
	<li class="cat-item cat-item-10"><a href="http://www.yota.tokyo/?cat=10">wireshark</a> (1)
</li>
	<li class="cat-item cat-item-11"><a href="http://www.yota.tokyo/?cat=11">wordpress</a> (2)
</li>
	<li class="cat-item cat-item-1"><a href="http://www.yota.tokyo/?cat=1">未分類</a> (1)
</li>
		</ul>
</section><section id="meta-2" class="widget widget_meta"><h2 class="widget-title">メタ情報</h2>			<ul>
			<li><a href="http://www.yota.tokyo/wp-admin/">サイト管理</a></li>			<li><a href="http://www.yota.tokyo/wp-login.php?action=logout&amp;_wpnonce=54339facdb">ログアウト</a></li>
			<li><a href="http://www.yota.tokyo/?feed=rss2">投稿の <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://www.yota.tokyo/?feed=comments-rss2">コメントの <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://ja.wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
			
			
			<div class="site-info">
								<span class="site-title"><a href="http://www.yota.tokyo/" rel="home">Open Full Stack</a></span>
				<a href="https://ja.wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

<script type="text/javascript" src="./2/skip-link-focus-fix.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"\u30b5\u30d6\u30e1\u30cb\u30e5\u30fc\u3092\u5c55\u958b","collapse":"\u30b5\u30d6\u30e1\u30cb\u30e5\u30fc\u3092\u9589\u3058\u308b"};
/* ]]> */
</script>
<script type="text/javascript" src="./2/functions.js"></script>
<script type="text/javascript" src="./2/wp-embed.min.js"></script>


</body></html>
