<!DOCTYPE html>
<!-- saved from url=(0022)http://www.yota.tokyo/ -->
<html lang="ja" class="js"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="profile" href="http://gmpg.org/xfn/11">
		<script>(function(html){html.className = html.className.replace(/\bno-js\b/,'js')})(document.documentElement);</script>
<title>Open Full Stack</title>
<link rel="dns-prefetch" href="http://www.yota.tokyo/">
<link rel="dns-prefetch" href="http://fonts.googleapis.com/">
<link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Open Full Stack » フィード" href="http://www.yota.tokyo/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="Open Full Stack » コメントフィード" href="http://www.yota.tokyo/?feed=comments-rss2">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":".\/1\/wp-emoji-release.min.js"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./1/wp-emoji-release.min.js" type="text/javascript"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="twentysixteen-fonts-css" href="./1/css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="./1/genericons.css" type="text/css" media="all">
<link rel="stylesheet" id="twentysixteen-style-css" href="./1/style.css" type="text/css" media="all">
<style id="twentysixteen-style-inline-css" type="text/css">

		/* Custom Page Background Color */
		.site {
			background-color: #e0dfd5;
		}

		mark,
		ins,
		button,
		button[disabled]:hover,
		button[disabled]:focus,
		input[type="button"],
		input[type="button"][disabled]:hover,
		input[type="button"][disabled]:focus,
		input[type="reset"],
		input[type="reset"][disabled]:hover,
		input[type="reset"][disabled]:focus,
		input[type="submit"],
		input[type="submit"][disabled]:hover,
		input[type="submit"][disabled]:focus,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.pagination .prev,
		.pagination .next,
		.pagination .prev:hover,
		.pagination .prev:focus,
		.pagination .next:hover,
		.pagination .next:focus,
		.pagination .nav-links:before,
		.pagination .nav-links:after,
		.widget_calendar tbody a,
		.widget_calendar tbody a:hover,
		.widget_calendar tbody a:focus,
		.page-links a,
		.page-links a:hover,
		.page-links a:focus {
			color: #e0dfd5;
		}

		@media screen and (min-width: 56.875em) {
			.main-navigation ul ul li {
				background-color: #e0dfd5;
			}

			.main-navigation ul ul:after {
				border-top-color: #e0dfd5;
				border-bottom-color: #e0dfd5;
			}
		}
	

		/* Custom Main Text Color */
		body,
		blockquote cite,
		blockquote small,
		.main-navigation a,
		.menu-toggle,
		.dropdown-toggle,
		.social-navigation a,
		.post-navigation a,
		.pagination a:hover,
		.pagination a:focus,
		.widget-title a,
		.site-branding .site-title a,
		.entry-title a,
		.page-links > .page-links-title,
		.comment-author,
		.comment-reply-title small a:hover,
		.comment-reply-title small a:focus {
			color: #494949
		}

		blockquote,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.post-navigation,
		.post-navigation div + div,
		.pagination,
		.widget,
		.page-header,
		.page-links a,
		.comments-title,
		.comment-reply-title {
			border-color: #494949;
		}

		button,
		button[disabled]:hover,
		button[disabled]:focus,
		input[type="button"],
		input[type="button"][disabled]:hover,
		input[type="button"][disabled]:focus,
		input[type="reset"],
		input[type="reset"][disabled]:hover,
		input[type="reset"][disabled]:focus,
		input[type="submit"],
		input[type="submit"][disabled]:hover,
		input[type="submit"][disabled]:focus,
		.menu-toggle.toggled-on,
		.menu-toggle.toggled-on:hover,
		.menu-toggle.toggled-on:focus,
		.pagination:before,
		.pagination:after,
		.pagination .prev,
		.pagination .next,
		.page-links a {
			background-color: #494949;
		}

		/* Border Color */
		fieldset,
		pre,
		abbr,
		acronym,
		table,
		th,
		td,
		input[type="date"],
		input[type="time"],
		input[type="datetime-local"],
		input[type="week"],
		input[type="month"],
		input[type="text"],
		input[type="email"],
		input[type="url"],
		input[type="password"],
		input[type="search"],
		input[type="tel"],
		input[type="number"],
		textarea,
		.main-navigation li,
		.main-navigation .primary-menu,
		.menu-toggle,
		.dropdown-toggle:after,
		.social-navigation a,
		.image-navigation,
		.comment-navigation,
		.tagcloud a,
		.entry-content,
		.entry-summary,
		.page-links a,
		.page-links > span,
		.comment-list article,
		.comment-list .pingback,
		.comment-list .trackback,
		.comment-reply-link,
		.no-comments,
		.widecolumn .mu_register .mu_alert {
			border-color: #494949; /* Fallback for IE7 and IE8 */
			border-color: rgba( 73, 73, 73, 0.2);
		}

		hr,
		code {
			background-color: #494949; /* Fallback for IE7 and IE8 */
			background-color: rgba( 73, 73, 73, 0.2);
		}

		@media screen and (min-width: 56.875em) {
			.main-navigation ul ul,
			.main-navigation ul ul li {
				border-color: rgba( 73, 73, 73, 0.2);
			}

			.main-navigation ul ul:before {
				border-top-color: rgba( 73, 73, 73, 0.2);
				border-bottom-color: rgba( 73, 73, 73, 0.2);
			}
		}
	
</style>
<!--[if lt IE 10]>
<link rel='stylesheet' id='twentysixteen-ie-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentysixteen-ie8-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie8.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 8]>
<link rel='stylesheet' id='twentysixteen-ie7-css'  href='http://www.yota.tokyo/wp-content/themes/twentysixteen/css/ie7.css?ver=20160816' type='text/css' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script type='text/javascript' src='http://www.yota.tokyo/wp-content/themes/twentysixteen/js/html5.js?ver=3.7.3'></script>
<![endif]-->
<script type="text/javascript" src="./1/jquery.js"></script>
<script type="text/javascript" src="./1/jquery-migrate.min.js"></script>
<link rel="https://api.w.org/" href="http://www.yota.tokyo/?rest_route=/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.yota.tokyo/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.yota.tokyo/wp-includes/wlwmanifest.xml"> 
<meta name="generator" content="WordPress 4.6.1">
<style type="text/css" id="custom-background-css">
body.custom-background { background-color: #e0dfd5; }
</style>
<link rel="icon" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-32x32.png" sizes="32x32">
<link rel="icon" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-192x192.png" sizes="192x192">
<link rel="apple-touch-icon-precomposed" href="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-180x180.png">
<meta name="msapplication-TileImage" content="http://www.yota.tokyo/wp-content/uploads/2016/02/cropped-sun-270x270.png">
</head>

<body class="home blog logged-in custom-background hfeed">
<div id="page" class="site">
	<div class="site-inner">
		<a class="skip-link screen-reader-text" href="http://www.yota.tokyo/#content">コンテンツへスキップ</a>

		<header id="masthead" class="site-header" role="banner">
			<div class="site-header-main">
				<div class="site-branding">
					
											<h1 class="site-title"><a href="http://www.yota.tokyo/" rel="home">Open Full Stack</a></h1>
									</div><!-- .site-branding -->

							</div><!-- .site-header-main -->

					</header><!-- .site-header -->

		<div id="content" class="site-content">

	<div id="primary" class="content-area">
		<main id="main" class="site-main" role="main">

		
			
			
<article id="post-106" class="post-106 post type-post status-publish format-standard hentry category-1">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=106" rel="bookmark">WebGLのサンプル</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>最近Three.jsを学習しています。その中で、なんかすごいWebGLのサンプルを見つけたので挙げておきます。</p>
<p>http://glslsandbox.com/e#22197.0</p>
<p>火とか、海みたいな感じでなんか見てしまう…</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=106" rel="bookmark"><time class="entry-date published updated" datetime="2016-09-18T18:40:09+00:00">2016-09-18</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=1" rel="category">未分類</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=106&amp;action=edit"><span class="screen-reader-text">"WebGLのサンプル"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-102" class="post-102 post type-post status-publish format-standard hentry category-bower category-browserify category-gulp category-node-js">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=102" rel="bookmark">Node.js界隈の開発ツール簡易まとめ</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Node.jsで開発していると幾つかのツールに出会います。</p>
<p>今まではとりあえず無視してたけど、さすがにある程度学んで置こうと思い、簡単にまとめます。ちなみに、ここで紹介するツールはNode.jsで動作しますが、どれもフロントエンドの開発に役立ちますので、全てWebアプリプロジェクトで導入可能です。</p>
<ul>
<li>gulp</li>
<li>browserify</li>
<li>bower</li>
</ul>
<p>gulpはタスクツールという位置づけです。フロントエンドの開発ではcssやjsのminify、TypescriptやCoffeescriptのビルド等の作業はありますよね。これをやってくれるのが、gulp(実際にはその様な作業を行うgulpのプラグインを探すことになる)です。gulpはNode.jsのStreamAPIを利用していて、shellの操作に慣れている人はパイプで標準出力を繋げていくような感じで理解し易いと思います。watchという機能もあり、開発中のソースの変更点を監視して、変更毎にタスクを実行してくれます。今までminifyをするほどのソースを作成していませんでしたが、format系のプラグイン等もあり、コーディング規約等の統一に一役買ってくれるのではないかと期待しています。</p>
<p>次に説明するのがbrowserifyです。browserifyはNode.jsで公開されているライブラリをブラウザで利用できるようにするツールです。実はNode.jsはjavascriptで書かれていますが、それらが全てブラウザで利用できるわけでありません。例えばブラウザでポート80番をリッスンするなんて不可能ですよね。ですがたとえば高度な暗号化ライブラリ等がNode.jsにはデフォルトありこれらがクライアントサイドで利用できれば…よさげな感じがします(cryptoモジュールがそのまま利用できるかどうかは未検証ですが)。</p>
<p>また、Node.jsにはnpmというパッケージ管理ツールが存在し、npmリポジトリは数多くのライブラリが公開されています。それらはもちろんNode.jsで作成されていますが、これをブラウザで利用できれば開発の幅が更に広がります。他にもHTMLフォームのバリデーションのソースコードをNode.jsで書いてブラウザ側も共通で利用するとか、ブラウザとサーバ側で大体同じ意味のソースを二重に書く手間がなくなります。</p>
<p>bowerはフロントエンドのライブラリ管理ツールです。操作方法はnpmコマンドとほぼ同様に利用できるようです。例えばどこでも利用するようなjqueryを以下の様にインストールします。</p>
<pre class="code" data-unlink="">$ bower install jquery --save</pre>
<p>簡単ですね。ただい、インストールしたフォルダの構造を確認してからscriptタグに記述する必要があり、ここらへんもう少し何かが必要そうな感じです。</p>
<p>とりあえず今回は以上。本当に触りしかしない簡単な回です。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=102" rel="bookmark"><time class="entry-date published updated" datetime="2016-08-29T22:26:25+00:00">2016-08-29</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=21" rel="category">bower</a>, <a href="http://www.yota.tokyo/?cat=22" rel="category">browserify</a>, <a href="http://www.yota.tokyo/?cat=20" rel="category">gulp</a>, <a href="http://www.yota.tokyo/?cat=13" rel="category">node.js</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=102&amp;action=edit"><span class="screen-reader-text">"Node.js界隈の開発ツール簡易まとめ"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-99" class="post-99 post type-post status-publish format-standard hentry category-node-js">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=99" rel="bookmark">make10の作成について</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>Node.jsでmake10を作成しました。</p>
<p><a href="https://github.com/kajiiiro/make10">https://github.com/kajiiiro/make10</a></p>
<p>車のナンバー等を計算するものです。ルールが少しマイナーなようです。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=99" rel="bookmark"><time class="entry-date published" datetime="2016-08-28T22:05:14+00:00">2016-08-28</time><time class="updated" datetime="2016-08-28T22:05:42+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=13" rel="category">node.js</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=99&amp;action=edit"><span class="screen-reader-text">"make10の作成について"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-96" class="post-96 post type-post status-publish format-standard hentry category-aws">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=96" rel="bookmark">AWSリージョンにおける時間差について</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>最近記事にするようなことがなかったので、とりあえず簡単な記事を上げます。</p>
<p>AWSでリージョンを意識せずに仮想マシンを利用していました。SSHがもっさりしていて不満があり、初めはt2.microのスペックによるものかと考えていたのです。仕事でリージョンの話をしていた時に、ふとひらめき試しにEU（アイルランド）からアジアパシフィック（東京）に変更してみました。</p>
<p>早い（というか通常のSSHです）！やっぱり海越えは遅いようです。ただし注意点があります。EU（アイルランド）で合計$0.02だったのが、アジアパシフィック（東京）では合計$0.03でした。これだけ見ると2円と3円の違いですが、割合でみると150％の違いがあります。結局アジアは高いということですね。</p>
<p>&nbsp;</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=96" rel="bookmark"><time class="entry-date published" datetime="2016-04-05T15:57:22+00:00">2016-04-05</time><time class="updated" datetime="2016-08-28T22:06:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=19" rel="category">aws</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=96&amp;action=edit"><span class="screen-reader-text">"AWSリージョンにおける時間差について"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-83" class="post-83 post type-post status-publish format-standard hentry category-azure category-iaas">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=83" rel="bookmark">Azureでシステム構築を行った件について</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>仕事としてIaaSを利用しました。利用したのはMicrosoft Azureです。利用してみての感想として、WebUIが綺麗でAWSよりは取っ付き易いと感じました。</p>
<p>ただし、すべてのことがWebUIでできるわけではなく、ロードバランサ等の構築はAzureCLI等を利用して構築する必要があります。また、一般的なWebシステムの構築に関わる部分は完成されていますが、Azure IoT Suite等プレビュー版として定義されているものも多くまだまだ発展段階の印象を受けました。</p>
<p>一番感動したのはMachine Learningです。ドラッグ＆ドロップで機械学習を利用でき、なんだかんだ言ってやっぱマイクロソフトってすごいな！と思いました。</p>
<p>今回Azureでシステムを構築する上での注意点を挙げておこうと思います。</p>
<p>Azure仮想マシンとしてcentos7.1、node.jsとtediousの組み合わせで、Azure SQL DBを利用してました。Azureを利用している大多数は管理コストを減らすためにSaaSとしてのDBを利用すると思います。AzureのSaaSとしてのRDBMSはSQL Serverしかありませんので、今回はLinuxからSQL Serverへの接続となりました。ちなみに、AWSはpostgresqlがSaaSとしてあります（Linuxユーザはこちらのほうがありがたいはず）。</p>
<p>結論から述べると、Azure SQL DBはコネクションを貼る時間が遅いです。平均400msから500ms、一番遅くて5000ms（5秒）かかることもありました。</p>
<p>tediousライブラリはAzureの公式ページにAzure SQL DBへのアクセス例として載っています。ですが、このまま利用すると簡単なアプリケーションでももっさりとした感じになります。この解決方法としてtedious-connection-poolを利用してください。コネクションを予め用意してくれるので、コネクションにかかる時間が平均50ms以下となり劇的に早くなります。</p>
<p>Azure SQL DBの遅さ同様、仮想マシンのSSHアクセスについても遅い時があります。vimでファイル編集しているときにSSHが切れたりすることが頻繁にありました。</p>
<p>Azureのちょっとした不満を書きましたが、IaaSはすごいです。ハードウェアやミドルウェアを一から準備することに比べたら、開発の初速が違いますので、上記の調査にかかったコストは全然気になりません。Azure最高です。だけど次はAWSを使いたい。</p>
<p>&nbsp;</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=83" rel="bookmark"><time class="entry-date published" datetime="2016-01-19T23:10:09+00:00">2016-01-19</time><time class="updated" datetime="2016-08-28T20:08:35+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=17" rel="category">azure</a>, <a href="http://www.yota.tokyo/?cat=18" rel="category">iaas</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=83&amp;action=edit"><span class="screen-reader-text">"Azureでシステム構築を行った件について"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-80" class="post-80 post type-post status-publish format-standard hentry category-node-js">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=80" rel="bookmark">ユニットテストにおける各データ型のパターンについて</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>最近、私はNode.jsでユニットテストを実装していました。</p>
<p>そこで、テストケースの実装ですら自動化とまでいかなくても大体はパターンで記述できると考えました。</p>
<p>基本的にユニットテストの対象はライブラリの関数やプロパティです。それらが設計書通りに定義されているかを確認していきます。固定値のプロパティなどは設計書通りに設定されているかを確認するだけなのでパターンはありません。やはり問題となるのは関数のユニットテストとなります。本記事ではそこにスポットを当てていきます。</p>
<p>始めに条件を記載していきます。まず一番重要なのが、設計の段階でその関数が特定の入力に対して、必ず特定の出力するよう設計を行うことが重要です。そのように設計されていない場合、ユニットテストを行うのが難しくなります。例えば入力されたByte数の乱数を生成するcrypto.randomBytesのような関数は出力が一定ではないので、想定するByte数になっているかどうかぐらいしかチェックできません。そのため以降は前者の条件を満たしているものとして記述します。</p>
<p>特定の入力に対して特定の出力を行う関数の「入力」と「出力」とはなんでしょうか。ここでの入力は関数の引数だけでなく、関数内部で利用された設定ファイルの値であったり、グローバル変数(今のご時世、固定値以外のグローバル変数を使っていると開発レベルが低いなと感じます)であったり、DBの値であったりです。出力もほぼ同様で、まずは戻り値(Node.jsの場合コールバック)、後はログファイルやDBです。</p>
<p>ユニットテストを行う上で意識することはすべてのテストケースで同じ条件にするべきだということです。話を簡単にするために入力は引数とDB、出力はコールバックに与えたオブジェクトというライブラリがあったとします。引数はテストケース毎に与えるでしょう。DBのデータは毎テストケース毎に初期化します。私はpower-assert, mocha, intelli-espower-loaderの組み合わせでユニットケースを記載しますが、beforeEachにテストDBデータを挿入する処理を記述し、afterEachにテストDBデータを削除する処理を記述します。こうするとテストの関数がDBに影響を与えるかどうかを検討対象から除外するため、格段にテストコードが書きやすくなります。テストの実行時間はもたつくかもしれませんが、条件が統一される実装時間とメンテナンス時間のメリットが時間のコストを上回るかと考えています。</p>
<p>ここで本題です。上記のような方法で出力の影響因子を引数に限定しました。そのため後はテストケースで与える引数を変えていくだけです。データ型毎にどのようなパターンが考えられるかをまとめました。以下のパターンは典型的なテストで、ほぼ考えるのでなく、体で覚えて書くことが多いと思います。それらを一度整理し体系的にまとめておくことは有益かなと思います。みなさまの参考になればと思います。</p>
<ul>
<li>number
<ul>
<li>null, undefined</li>
<li>データ範囲がある場合は限界値分析と同値分析の混合
<ul>
<li>例）0から100までと定義されている場合は、限界値として-1, 0, 1, 99, 100, 101、同値として-50, 50, 150(限界値でチェックできているのであれば不要)</li>
</ul>
</li>
<li>0</li>
<li>整数を期待する場合は少数</li>
<li>enumのような使い方の場合は未定義値</li>
<li>異常値
<ul>
<li>-9999999999…., 9999999999….., 0.000…..0000000001等のぶっ飛んだ桁数(32,64bitで表現可能な範囲を超えていたり)入力</li>
</ul>
</li>
</ul>
</li>
<li>string
<ul>
<li>null, undefined</li>
<li>文字数の制限がある場合は限界値分析
<ul>
<li>大抵情報はDBに格納されると思うので、DBのデータ型のバイト数も考慮に入れる</li>
</ul>
</li>
<li>空文字列</li>
<li>base64等エンコード形式が決まっている場合は異なるエンコード形式の値</li>
<li>enumのような使い方の場合は未定義値</li>
<li>異常値
<ul>
<li>文字列の異常値って何があるのか…。ここは今でも悩むところで現状実装していないことが多い</li>
</ul>
</li>
</ul>
</li>
<li>function（つまりコールバック）
<ul>
<li>null, undeinfed</li>
<li>他にチェックすべきことがあれば教えて欲しいです</li>
</ul>
</li>
<li>object
<ul>
<li>null, undefined</li>
<li>末端はnumberやstring, function等になると思うので、それら毎のテスト</li>
<li>必須項目のキーを設定しない
<ul>
<li>例）httpリクエストを飛ばす関数にあって引数がobjectであればおそらくurlというキーの値が必須となるはずである。そのurlを設定していないobjectを渡す</li>
</ul>
</li>
<li>項目数0</li>
<li>設定可能なキーの組み合わせ
<ul>
<li>すべての組み合わせをやろうとすると指数関数的にテストケースが増えますが。その割に効果が少ないことが多いかもしれません。ですので、関係のある項目の組み合わせだけに絞っても良い方と思います。</li>
<li>例）httpリクエストを飛ばす関数にあって引数がobjectであればurlとmethod(GET, PUT, POST, DELETE等)があると思います。それらの組み合わせを意味します。</li>
</ul>
</li>
<li>未定義のキーを設定してみる</li>
</ul>
</li>
<li>array
<ul>
<li>null, undefined</li>
<li><span style="line-height: 1.6471;">末端はnumberやstring, function等になると思うので、それら毎のテスト</span></li>
<li>配列の要素数が規定されている場合は限界値分析</li>
<li>要素数0</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=80" rel="bookmark"><time class="entry-date published" datetime="2015-12-05T21:05:24+00:00">2015-12-05</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=13" rel="category">node.js</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=80&amp;action=edit"><span class="screen-reader-text">"ユニットテストにおける各データ型のパターンについて"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-74" class="post-74 post type-post status-publish format-standard hentry category-nginx">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=74" rel="bookmark">nginxでのリファラ(referer)制限について</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>nginxでリファラ制限を行う方法を調べている時に、google検索上位にあるwebサイトで間違った記述を見つけました。ですので、動作検証をもとに確認を行いました。</p>
<p>centos6.6. nginx 1.8.0環境で以下の様な設定です。</p>
<pre># cat /etc/nginx/conf.d/test.conf
server {
  listen 80;
  server_name test.example.com;
  location / {
    root /usr/share/nginx/html;
    valid_referers server_names;
    if ($invalid_referer) {
      return 403;
    }
  }
}</pre>
<p>設定内容としてはyumインストールでのデフォルトのドキュメントルートにリファラ制限を加えただけになります。</p>
<p>ここでvalid_referersディレクティブの機能は、組み込み変数$invalid_refererを空に設定する条件を指定するものです。つまりここで指定されたものは許可されるというものです。valid_referersにはnone（リファラが空）、blocked（リファラにhttp://で始まらない等の不正）、server_names（server_nameに指定したドメインからのアクセス）、正規表現等が利用できます。</p>
<p>私が見つけたサイトではnoneを指定しているにも関わらず、リファラが空である場合に制限するとなっていました。これは間違いで、以下の様にすると簡単にnginxサーバ内部で動作確認できます。</p>
<p>※前準備として/etc/hostsにserver_namesに指定したドメインの名前解決を127.0.0.1にするようにして下さい。</p>
<pre>### ①refererが無いリクエスト
# curl test.example.com
### ②不正なリファラを設定するリクエスト
# curl test.example.com -H "Referer: test.example.com"
### ③別ドメインからのリクエスト
# curl test.example.com -H "Referer: <a href="http://nginx.org/">http://nginx.org/</a>"
### ④server_namesに指定したドメインからのリクエスト
# curl test.example.com -H "Referer: http://test.example.com"</pre>
<p>上記のリクエストの内、①/②/③は403のエラーページが返ります。④については正常にnginxのwelcomページが返ります。</p>
<p>valid_referersにnoneを指定したら①、blockedを指定したら②もwelcomページが返る様になります。③を許可したい場合はnginx.orgと文字列を追記してやるだけです。</p>
<pre> valid_referers none blocked server_names nginx.org;</pre>
<p>まとめるとvalid_referersはホワイトリストであるということでした。だけどif is evilとあるようにifはディレクティブ内に1つにとどめた方が良さそうです。</p>
<p>公式のドキュメント：http://nginx.org/en/docs/http/ngx_http_referer_module.html</p>
<p>if is evil：https://www.nginx.com/resources/wiki/start/topics/depth/ifisevil/</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=74" rel="bookmark"><time class="entry-date published" datetime="2015-10-01T11:13:21+00:00">2015-10-01</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=16" rel="category">nginx</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=74&amp;action=edit"><span class="screen-reader-text">"nginxでのリファラ(referer)制限について"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-70" class="post-70 post type-post status-publish format-standard hentry category-centos category-nginx category-php category-wordpress">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=70" rel="bookmark">wordpressのインストール時に微妙に困る事</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>wordpressをcentos6.6 minimalにインストールする機会がありました。その際に参考にした以下の日本語公式サイトが痒いところに手が届かない感じだったので、今回記事にしようと思います。</p>
<p>http://wpdocs.osdn.jp/WordPress_のインストール</p>
<p>mysqlについては多少知っていたので苦労することはありませんでした。 行ったことはユーザの作成、データベースの作成、データベースのユーザへの権限設定です。</p>
<p>私はphpについての知識があまりないので、phpが動かせるwebサーバの設定を載せます。</p>
<p>今回はnginxでphpを動かす設定をいれます。まずは以下のコマンドで必要パッケージをインストールして下さい。php-fpmは単体ではphpを利用していない？様でphpパッケージのインストールを忘れて進んでたらこの環境はphp使えないねって怒られます。</p>
<pre># yum install http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm
# yum install php php-fpm nginx</pre>
<p>そして以下のサイトを参考にnginxとphp-fpmの設定を行ないます。</p>
<p>http://qiita.com/utano320/items/36b6eac2bbd5bb5657f6</p>
<p>上記サイトはドキュメントルートを/var/wwwに設定している。wordpressのディレクトリをここに持ってきて、nginxのドキュメントルート設定を/var/www/wordpressとかにすればOKです。</p>
<p>ここまできたら、インストール手順の前提が揃うことになるので、手順に従いインストールを行って下さい。</p>
<p>&nbsp;</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=70" rel="bookmark"><time class="entry-date published" datetime="2015-08-08T07:57:36+00:00">2015-08-08</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=2" rel="category">centos</a>, <a href="http://www.yota.tokyo/?cat=16" rel="category">nginx</a>, <a href="http://www.yota.tokyo/?cat=15" rel="category">php</a>, <a href="http://www.yota.tokyo/?cat=11" rel="category">wordpress</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=70&amp;action=edit"><span class="screen-reader-text">"wordpressのインストール時に微妙に困る事"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-51" class="post-51 post type-post status-publish format-standard hentry category-github category-javascript category-node-js category-postgresql">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=51" rel="bookmark">未だに多いエクセル管理をやめたくてnodeでアプリ作った</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p>インフラ系投稿ばかりではFull Stackと言えそうにないので、アプリの投稿をします。</p>
<p>w2uiというライブラリを使ってexcelライクなwebアプリを作成しました。名前は<a href="https://github.com/kajiiiro/nmeta.git" target="_blank">nmeta</a>です。githubに登録しているので気軽に試すことが出来ます。以下にサーバへインストールする手順を示そうと思います。</p>
<p>まずは各種バージョン情報を等を示します。</p>
<p>centos : 6.6 node.js : 0.12.6 postgresql : 8.4</p>
<p>まずはnodeのバージョン管理を行うnvmのインストールを行います。github:nvmのreadmeページを参考にインストールを行います。</p>
<pre># curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.25.4/install/sh | bash
# source ~/.bashrc
# nvm install stable # 2015/07/10現在 v0.12.6がインストールされる
# nvm alias default stable</pre>
<p>gitを入れてnmetaをダウンロードします。postgresqlの設定も行います。</p>
<pre># yum install -y git
# git clone https://github.com/kajiiiro/nmeta.git
# yum install -y postgresql-server postgresql-contrib
# chkconfig postgresql on
# service postgresql initdb
# vi /var/lib/pgsql/data/pg_hba.conf # methodをidentからtrustに変更
# service postgresql start
# cd nmeta/ddl
# psql postgres postgres &lt; /usr/share/pgsql/contrib/uuid-ossp.sql
# ./restore.sh</pre>
<p>そして関連パッケージのインストールと起動を行います。</p>
<pre># cd nmeta
# npm install
# npm install pm2 -g
# npm start        # pm2経由でアプリを起動
# pm2 delete nmeta # pm2経由でアプリを停止</pre>
<p>デフォルトは8080ポートで起動するのでアクセスしてみてください。アクセスすると名前と年齢を管理するページにつながります。</p>
<p><a href="./1/nmeta-sample.png"><img class="alignnone size-medium wp-image-61" src="./1/nmeta-sample-300x169.png" alt="nmeta-sample" width="300" height="169" srcset="./1/nmeta-sample-300x169.png 300w, ./1/nmeta-sample-1024x576.png 1024w, ./1/nmeta-sample.png 1366w" sizes="(max-width: 300px) 85vw, 300px"></a></p>
<p>&nbsp;</p>
<p>きっとこの内容をgithubのREADME.mdに記載するべきなんでしょうね…。いつか移行します。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=51" rel="bookmark"><time class="entry-date published" datetime="2015-07-10T00:52:03+00:00">2015-07-10</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=14" rel="category">github</a>, <a href="http://www.yota.tokyo/?cat=12" rel="category">javascript</a>, <a href="http://www.yota.tokyo/?cat=13" rel="category">node.js</a>, <a href="http://www.yota.tokyo/?cat=9" rel="category">postgresql</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=51&amp;action=edit"><span class="screen-reader-text">"未だに多いエクセル管理をやめたくてnodeでアプリ作った"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

<article id="post-39" class="post-39 post type-post status-publish format-standard hentry category-corosync category-drbd category-pacemaker category-postgresql">
	<header class="entry-header">
		
		<h2 class="entry-title"><a href="http://www.yota.tokyo/?p=39" rel="bookmark">drbd+pacemakerを用いたシェアードナッシングHAクラスタ②</a></h2>	</header><!-- .entry-header -->

	
	
	<div class="entry-content">
		<p><a href="http://www.yota.tokyo/?p=24">前回</a>までにpostgresqlの設定を行ったのでpacemakerのインストールから説明していきます。死活監視のツールはheartbeatではなく、corosyncを用います。heartbeatは枯れた技術ですので安定していて情報も豊富です。しかし、将来的な展望を考慮して複数ノードのクラスタへとステップアップしていけそうという思いからcorosyncを利用しました。</p>
<pre># yum install http://iij.dl.sourceforge.jp/linux-ha/62369/pacemaker-repo-1.1.12-1.1.el6.x86_64.rpm
# yum install pacemaker-all
# echo "export PCMK_fail=yes" &gt;&gt; /etc/sysconfig/pacemaker
# echo "export PCMK_logfile=/var/log/cluster/pacemaker.log" &gt;&gt; /etc/sysconfig/pacemaker
# mkdir /var/log/cluster
# cd /etc/init
# patch &lt; pacemaker.combined.conf.patch</pre>
<p>pacemaker.combined.conf.patchは以下のような内容です。</p>
<pre>*** pacemaker.combined.conf 2015-05-15 14:53:07.740433645 +0900
--- pacemaker.combined.conf.d 2015-05-15 14:53:20.778433760 +0900
***************
*** 1,63 ****
- # pacemaker-corosync - High-Availability cluster
- #
- # Starts Corosync cluster engine and Pacemaker cluster manager.
-
 kill timeout 3600
 respawn
-
 env prog=pacemakerd
 env rpm_sysconf=/etc/sysconfig/pacemaker
 env rpm_lockfile=/var/lock/subsys/pacemaker
 env deb_sysconf=/etc/default/pacemaker
 env deb_lockfile=/var/lock/pacemaker
-
 script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
 exec $prog
 end script
-
 pre-start script
! # setup the software watchdog which corosync uses.
! # rewrite according to environment.
! modprobe softdog soft_margin=60
 pidof corosync || start corosync
-
- # if you use corosync-notifyd, uncomment the line below.
- #start corosync-notifyd
-
- # give it time to fail.
 sleep 2
 pidof corosync || { exit 1; }
 end script
-
 post-start script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
! [ -z "$LOCK_FILE" -a -d /etc/sysconfig ] &amp;&amp; LOCK_FILE="$rpm_lockfile"
! [ -z "$LOCK_FILE" -a -d /etc/default ] &amp;&amp; LOCK_FILE="$deb_lockfile"
 touch $LOCK_FILE
 pidof $prog &gt; /var/run/$prog.pid
 end script
-
 post-stop script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
! [ -z "$LOCK_FILE" -a -d /etc/sysconfig ] &amp;&amp; LOCK_FILE="$rpm_lockfile"
! [ -z "$LOCK_FILE" -a -d /etc/default ] &amp;&amp; LOCK_FILE="$deb_lockfile"
 rm -f $LOCK_FILE
 rm -f /var/run/$prog.pid
!
! # if you use watchdog of corosync, uncomment the line below.
! #pidof corosync || false
!
 pidof crmd || stop corosync
-
- # if you want to reboot a machine by watchdog of corosync when
- # pacemakerd disappeared unexpectedly, uncomment the line below
- # and invalidate above "respawn" stanza.
- #pidof crmd &amp;&amp; killall -q -9 corosync
-
- # if you use corosync-notifyd, uncomment the line below.
- #stop corosync-notifyd || true
 end script
--- 1,36 ----
 kill timeout 3600
 respawn
 env prog=pacemakerd
 env rpm_sysconf=/etc/sysconfig/pacemaker
 env rpm_lockfile=/var/lock/subsys/pacemaker
 env deb_sysconf=/etc/default/pacemaker
 env deb_lockfile=/var/lock/pacemaker
 script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
 exec $prog
 end script
 pre-start script
! [ -c /dev/watchdog ] || modprobe softdog soft_margin=60
 pidof corosync || start corosync
 sleep 2
 pidof corosync || { exit 1; }
 end script
 post-start script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
! [ -z "$LOCK_FILE" -a -d /etc/sysconfig ] &amp;&amp; LOCK_FILE="$rpm_lockfile"
! [ -z "$LOCK_FILE" -a -d /etc/default ] &amp;&amp; LOCK_FILE="$deb_lockfile"
 touch $LOCK_FILE
 pidof $prog &gt; /var/run/$prog.pid
 end script
 post-stop script
 [ -f "$rpm_sysconf" ] &amp;&amp; . $rpm_sysconf
 [ -f "$deb_sysconf" ] &amp;&amp; . $deb_sysconf
! [ -z "$LOCK_FILE" -a -d /etc/sysconfig ] &amp;&amp; LOCK_FILE="$rpm_lockfile"
! [ -z "$LOCK_FILE" -a -d /etc/default ] &amp;&amp; LOCK_FILE="$deb_lockfile"
 rm -f $LOCK_FILE
 rm -f /var/run/$prog.pid
! pidof corosync || false
 pidof crmd || stop corosync
 end script</pre>
<p>パッチの適用により、watchdogが有効となりこの設定では60秒間/dev/watchdogへの書き込みがなかった場合にOSが再起動します。watchdogへの書き込みはcorosyncが行っています。そのため、corosyncを正常な方法で起動しないと再起動してしまいます。</p>
<pre># cat /etc/corosync/corosync.conf
compatibility: whitetank
service {
 name: pacemaker
 ver: 0
 use_mgmud: yes
}
totem {
 version: 2
 crypto_cipher: none
 crypto_hash: none
 secauth: off
 rrp_mode: none
 interface {
 ringnumber: 0
 bindnetaddr: 192.168.0.0
 mcastport: 5405
 ttl: 1
 }
 transport: udpu
}
logging {
 fileline: off
 to_stderr: no
 to_logfile: yes
 logfile: /var/log/cluster/corosync.log
 logfile_priority: info
 to_syslog: no
 debug: off
 timestamp: on
 logger_subsys {
 subsys: QUORUM
 debug: off
 }
}
nodelist {
 node {
 ring0_addr: 192.168.0.1
 nodeid: 1
 }
 node {
 ring0_addr: 192.168.0.2
 nodeid: 2
 }
}
quorum {
 provider: corosync_votequorum
 expected_votes: 2
}</pre>
<p>ここまで出来たら起動確認を行います。起動/停止は以下のように行います。また、クラスタの状態を確認するコマンドも以下に載せます。</p>
<pre># initctl start pacemaker.combined
# initctl stop  pacemaker.combined
# crm # topコマンドのように画面が切り替わり、認識したノードやリソース情報がわかる</pre>
<p>pacemakerを起動した状態でcrmコマンドで管理するリソースの設定を行います。以下の内容のファイル(crm.ini)を作成します。</p>
<pre>property stonith-enabled="false" \
 no-quorum-policy="ignore" \
 crmd-transition-delay="2s" 
rsc_defaults resource-stickiness="INFINITY" \
 migration-threshold="1" 
primitive pr_ping2gw ocf:pacemaker:ping \
 params name="ping_to_gateway" host_list="192.168.0.254" multiplier="100" dampen="1" \
 op monitor interval="10s" timeout="60" \
 op start timeout="60" 
primitive pr_vip ocf:heartbeat:IPaddr2 \
 params ip=192.168.0.100 nic="eth0" cidr_netmask="24" \
 op monitor interval="10s" 
primitive pr_postgres_drbd ocf:linbit:drbd \
 params drbd_resource="postgres" \
 op start interval="0s" timeout="240s" \
 op stop interval="0s" timeout="100s" \
 op monitor interval="15s" timeout="60s" role="Master" \
 op monitor interval="30s" timeout="60s" role="Slave" 
primitive pr_fs_postgres_drbd ocf:heartbeat:Filesystem \
 params device="/dev/drbd0" directory="/var/lib/pgsql/9.4/data" fstype="ext4" \
 op start interval="0s" timeout="60s" \
 op stop interval="0s" timeout="60s" \
 op monitor interval="30s" timeout="40s" 
primitive pr_postgres ocf:heartbeat:pgsql \
 params pgctl="/usr/pgsql-9.4/bin/pg_ctl" \
 psql="/usr/pgsql-9.4/bin/psql" \
 pgdata="/var/lib/pgsql/9.4/data" \
 pghost="192.168.0.100" \
 op start interval="0s" timeout="120s" \
 op monitor interval="10s" timeout="60s" \
 op stop interval="0s" timeout="120s" 
ms ms_postgres_drbd pr_postgres_drbd \
 meta master-max="1" master-node-max="1" \
 clone-max="2" clone-node-max="1" notify="true" \
 is-managed="true" target-role="Started" 
group grp_postgres pr_vip pr_fs_postgres_drbd pr_postgres
clone clo_ping2gw pr_ping2gw
location loc_ping grp_postgres \
 rule -inf: not_defined ping_to_gateway or ping_to_gateway lt 100
colocation col_postgres_on_drbd inf: grp_postgres ms_postgres_drbd:Master
order ord_postgres_after_drbd inf: ms_postgres_drbd:promote grp_postgres:start</pre>
<p>上記で作成したcrm.iniを以下のコマンドでpacemakerに登録したら、クラスタの出来上がりです。</p>
<pre># crm configure load update crm.ini</pre>
<p>長い戦いが終わりました。慣れてしまえば意外と早く設定出来ます。</p>
<p>ここで注意点があります。pacemakerに登録できるリソースにlsbというのがあります。これは特定の条件を満たしたinitスクリプトのことを指すのですが、lsb準拠のinitスクリプトはリソース登録できるのです。postgresqlはyumで入れるとinitスクリプトがありますがこれでもクラスタは動きます。ですが試験を行った結果、全くフェールオーバ(“killall -9 postmaster”で強制終了しました)してくれず、冗長化の意味をなさないという問題が起きました。これは監視方法が違うためでinitスクリプトはstatus(“service *** status”)の結果を見るのに対し、ocf:heartbeat:pgsqlはちゃんとサービス監視をしてくれるのです(詳細は失念しました…)。同様にapache等もinitスクリプトではフェールオーバしてくれず、ocf:heartbeatを利用した方が良いです…というかocf:heartbeatにあればそちらを利用した方が良さそうです。</p>
<p>またgatewayへのping監視も注意が必要です。crm.iniの最後の方にlocation指定しポイント付を行っていますが、これがないとgatewayにpingが飛ばなくてもフェールオーバしてくれません。pingの設定してるんだから失敗したらフェールオーバしてほしいものですが、pingの宛先が複数存在した場合の挙動を柔軟に設定するためにこのような方法をとっているのだと解釈しています。</p>
<p>今回は一番利用効果が大きいと思われるdrbdを例に載せました。あくまでもサービスの可用性のみを高める方法なので、性能を上げるためにはLB等が必要になります。この他にも私はnginx、drbd+nfs、drbd+mysql、drbd+apache+zabbixの冗長化を行った経験があります。基本的になんでも冗長化できるということはインフラエンジニアとしては武器になると思いますので、これからも活用していきたいものです。</p>
	</div><!-- .entry-content -->

	<footer class="entry-footer">
		<span class="byline"><span class="author vcard"><img alt="" src="./1/b448a72e3f30e454f7a55ac06a67e448" srcset="http://2.gravatar.com/avatar/b448a72e3f30e454f7a55ac06a67e448?s=98&amp;r=g 2x" class="avatar avatar-49 photo" height="49" width="49"><span class="screen-reader-text">投稿者 </span> <a class="url fn n" href="http://www.yota.tokyo/?author=1">yota</a></span></span><span class="posted-on"><span class="screen-reader-text">投稿日: </span><a href="http://www.yota.tokyo/?p=39" rel="bookmark"><time class="entry-date published" datetime="2015-07-07T23:25:46+00:00">2015-07-07</time><time class="updated" datetime="2016-08-28T20:08:36+00:00">2016-08-28</time></a></span><span class="cat-links"><span class="screen-reader-text">カテゴリー </span><a href="http://www.yota.tokyo/?cat=8" rel="category">corosync</a>, <a href="http://www.yota.tokyo/?cat=6" rel="category">drbd</a>, <a href="http://www.yota.tokyo/?cat=7" rel="category">pacemaker</a>, <a href="http://www.yota.tokyo/?cat=9" rel="category">postgresql</a></span>		<span class="edit-link"><a class="post-edit-link" href="http://www.yota.tokyo/wp-admin/post.php?post=39&amp;action=edit"><span class="screen-reader-text">"drbd+pacemakerを用いたシェアードナッシングHAクラスタ②"を</span>編集</a></span>	</footer><!-- .entry-footer -->
</article><!-- #post-## -->

	<nav class="navigation pagination" role="navigation">
		<h2 class="screen-reader-text">投稿ナビゲーション</h2>
		<div class="nav-links"><span class="page-numbers current"><span class="meta-nav screen-reader-text">ページ </span>1</span>
<a class="page-numbers" href="http://www.yota.tokyo/?paged=2"><span class="meta-nav screen-reader-text">ページ </span>2</a>
<a class="next page-numbers" href="http://www.yota.tokyo/?paged=2">次のページ</a></div>
	</nav>
		</main><!-- .site-main -->
	</div><!-- .content-area -->


	<aside id="secondary" class="sidebar widget-area" role="complementary">
		<section id="search-2" class="widget widget_search">
<form role="search" method="get" class="search-form" action="http://www.yota.tokyo/">
	<label>
		<span class="screen-reader-text">検索対象:</span>
		<input type="search" class="search-field" placeholder="検索 …" value="" name="s">
	</label>
	<button type="submit" class="search-submit"><span class="screen-reader-text">検索</span></button>
</form>
</section><section id="archives-2" class="widget widget_archive"><h2 class="widget-title">アーカイブ</h2>		<ul>
			<li><a href="http://www.yota.tokyo/?m=201609">2016年9月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201608">2016年8月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201604">2016年4月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201601">2016年1月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201512">2015年12月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201510">2015年10月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201508">2015年8月</a>&nbsp;(1)</li>
	<li><a href="http://www.yota.tokyo/?m=201507">2015年7月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201506">2015年6月</a>&nbsp;(2)</li>
	<li><a href="http://www.yota.tokyo/?m=201505">2015年5月</a>&nbsp;(2)</li>
		</ul>
		</section><section id="pages-3" class="widget widget_pages"><h2 class="widget-title">本サイトについて</h2>		<ul>
			<li class="page_item page-item-15"><a href="http://www.yota.tokyo/?page_id=15">Open Full Stackとは？</a></li>
		</ul>
		</section><section id="categories-2" class="widget widget_categories"><h2 class="widget-title">カテゴリー</h2>		<ul>
	<li class="cat-item cat-item-19"><a href="http://www.yota.tokyo/?cat=19">aws</a> (1)
</li>
	<li class="cat-item cat-item-17"><a href="http://www.yota.tokyo/?cat=17">azure</a> (1)
</li>
	<li class="cat-item cat-item-21"><a href="http://www.yota.tokyo/?cat=21">bower</a> (1)
</li>
	<li class="cat-item cat-item-22"><a href="http://www.yota.tokyo/?cat=22">browserify</a> (1)
</li>
	<li class="cat-item cat-item-2"><a href="http://www.yota.tokyo/?cat=2">centos</a> (2)
</li>
	<li class="cat-item cat-item-8"><a href="http://www.yota.tokyo/?cat=8">corosync</a> (2)
</li>
	<li class="cat-item cat-item-6"><a href="http://www.yota.tokyo/?cat=6">drbd</a> (2)
</li>
	<li class="cat-item cat-item-14"><a href="http://www.yota.tokyo/?cat=14">github</a> (1)
</li>
	<li class="cat-item cat-item-20"><a href="http://www.yota.tokyo/?cat=20">gulp</a> (1)
</li>
	<li class="cat-item cat-item-18"><a href="http://www.yota.tokyo/?cat=18">iaas</a> (1)
</li>
	<li class="cat-item cat-item-12"><a href="http://www.yota.tokyo/?cat=12">javascript</a> (1)
</li>
	<li class="cat-item cat-item-16"><a href="http://www.yota.tokyo/?cat=16">nginx</a> (2)
</li>
	<li class="cat-item cat-item-13"><a href="http://www.yota.tokyo/?cat=13">node.js</a> (4)
</li>
	<li class="cat-item cat-item-7"><a href="http://www.yota.tokyo/?cat=7">pacemaker</a> (2)
</li>
	<li class="cat-item cat-item-15"><a href="http://www.yota.tokyo/?cat=15">php</a> (1)
</li>
	<li class="cat-item cat-item-9"><a href="http://www.yota.tokyo/?cat=9">postgresql</a> (4)
</li>
	<li class="cat-item cat-item-5"><a href="http://www.yota.tokyo/?cat=5">vyos</a> (1)
</li>
	<li class="cat-item cat-item-10"><a href="http://www.yota.tokyo/?cat=10">wireshark</a> (1)
</li>
	<li class="cat-item cat-item-11"><a href="http://www.yota.tokyo/?cat=11">wordpress</a> (2)
</li>
	<li class="cat-item cat-item-1"><a href="http://www.yota.tokyo/?cat=1">未分類</a> (1)
</li>
		</ul>
</section><section id="meta-2" class="widget widget_meta"><h2 class="widget-title">メタ情報</h2>			<ul>
			<li><a href="http://www.yota.tokyo/wp-admin/">サイト管理</a></li>			<li><a href="http://www.yota.tokyo/wp-login.php?action=logout&amp;_wpnonce=54339facdb">ログアウト</a></li>
			<li><a href="http://www.yota.tokyo/?feed=rss2">投稿の <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://www.yota.tokyo/?feed=comments-rss2">コメントの <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="https://ja.wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>			</ul>
			</section>	</aside><!-- .sidebar .widget-area -->

		</div><!-- .site-content -->

		<footer id="colophon" class="site-footer" role="contentinfo">
			
			
			<div class="site-info">
								<span class="site-title"><a href="http://www.yota.tokyo/" rel="home">Open Full Stack</a></span>
				<a href="https://ja.wordpress.org/">Proudly powered by WordPress</a>
			</div><!-- .site-info -->
		</footer><!-- .site-footer -->
	</div><!-- .site-inner -->
</div><!-- .site -->

<script type="text/javascript" src="./1/skip-link-focus-fix.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var screenReaderText = {"expand":"\u30b5\u30d6\u30e1\u30cb\u30e5\u30fc\u3092\u5c55\u958b","collapse":"\u30b5\u30d6\u30e1\u30cb\u30e5\u30fc\u3092\u9589\u3058\u308b"};
/* ]]> */
</script>
<script type="text/javascript" src="./1/functions.js"></script>
<script type="text/javascript" src="./1/wp-embed.min.js"></script>


</body></html>
